---
import DashboardLayout from '../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Gastos" activeSection="expenses">
  <div class="px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 class="text-3xl font-bold" style="background: linear-gradient(to right, #ef4444, #dc2626); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Gastos</h1>
        <p class="mt-2 text-slate-600">Control y gestión de gastos de la empresa</p>
      </div>
      <button id="addExpenseBtn" class="mt-4 sm:mt-0 btn-primary inline-flex items-center">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        Nuevo Gasto
      </button>
    </div>

    <!-- Filters -->
    <div class="card mb-6">
      <div class="p-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Buscar</label>
            <input type="text" id="searchInput" placeholder="Descripción o proveedor..." class="input-field w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Desde</label>
            <input type="date" id="startDate" class="input-field w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Hasta</label>
            <input type="date" id="endDate" class="input-field w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Categoría</label>
            <select id="categoryFilter" class="input-field w-full">
              <option value="">Todas</option>
            </select>
          </div>
        </div>
        <div class="mt-4 flex justify-end">
          <button id="searchBtn" class="btn-primary">Buscar</button>
        </div>
      </div>
    </div>

    <!-- Stats & Chart -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <div class="lg:col-span-2">
        <div class="card p-6">
          <h3 class="text-lg font-semibold text-slate-800 mb-4">Gastos por Categoría</h3>
          <div id="categoryChart" class="space-y-3">
            <p class="text-slate-500 text-sm">Cargando...</p>
          </div>
        </div>
      </div>
      <div class="space-y-4">
        <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
          <p class="text-sm text-slate-600">Gastos del Mes</p>
          <p class="text-2xl font-bold text-red-600" id="monthlyTotal">0 €</p>
        </div>
        <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
          <p class="text-sm text-slate-600">Total Gastos</p>
          <p class="text-2xl font-bold text-slate-900" id="totalExpenses">0 €</p>
        </div>
        <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
          <p class="text-sm text-slate-600">Nº de Gastos</p>
          <p class="text-2xl font-bold text-slate-900" id="expenseCount">0</p>
        </div>
      </div>
    </div>

    <!-- Expenses Table -->
    <div class="card">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-200">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Fecha</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Descripción</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Categoría</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Proveedor</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Importe</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody id="expensesTableBody" class="bg-white divide-y divide-slate-200">
            <tr>
              <td colspan="6" class="px-6 py-12 text-center text-slate-500">Cargando gastos...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Add/Edit Expense Modal -->
  <div id="expenseModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-slate-200">
        <h2 id="modalTitle" class="text-xl font-bold text-slate-900">Nuevo Gasto</h2>
      </div>
      <form id="expenseForm" class="p-6 space-y-4">
        <input type="hidden" id="expenseId">
        
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Descripción *</label>
          <input type="text" id="description" class="input-field w-full" required>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Importe (€) *</label>
            <input type="number" id="amount" step="0.01" min="0" class="input-field w-full" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Categoría</label>
            <select id="categoryId" class="input-field w-full">
              <option value="">Sin categoría</option>
            </select>
          </div>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Proveedor</label>
            <input type="text" id="vendor" class="input-field w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Fecha *</label>
            <input type="date" id="expenseDate" class="input-field w-full" required>
          </div>
        </div>
        
        <div class="flex items-center space-x-4">
          <label class="flex items-center">
            <input type="checkbox" id="isRecurring" class="mr-2">
            <span class="text-sm text-slate-700">Gasto recurrente</span>
          </label>
          <select id="recurringFrequency" class="input-field hidden">
            <option value="weekly">Semanal</option>
            <option value="monthly">Mensual</option>
            <option value="quarterly">Trimestral</option>
            <option value="yearly">Anual</option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Notas</label>
          <textarea id="notes" rows="2" class="input-field w-full"></textarea>
        </div>
        
        <div class="flex justify-end space-x-3 pt-4">
          <button type="button" id="cancelBtn" class="btn-secondary">Cancelar</button>
          <button type="submit" class="btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 p-6">
      <h2 class="text-xl font-bold text-slate-900 mb-4">Eliminar Gasto</h2>
      <p class="text-slate-600 mb-6">¿Estás seguro de que quieres eliminar este gasto?</p>
      <input type="hidden" id="deleteExpenseId">
      <div class="flex justify-end space-x-3">
        <button id="cancelDeleteBtn" class="btn-secondary">Cancelar</button>
        <button id="confirmDeleteBtn" class="btn-danger">Eliminar</button>
      </div>
    </div>
  </div>

  <script>
    import { getExpenses, searchExpenses, addExpense, updateExpense, deleteExpense, getExpenseCategories, getExpensesByCategory } from '../lib/supabase';
    import { checkAuth } from '../lib/auth';
    import { format } from 'date-fns';
    import { es } from 'date-fns/locale';

    let currentUser: any = null;
    let allExpenses: any[] = [];
    let categories: any[] = [];

    function formatCurrency(amount: number): string {
      return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(amount);
    }

    async function init() {
      currentUser = await checkAuth();
      if (!currentUser) return;

      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      (document.getElementById('startDate') as HTMLInputElement).value = firstDay.toISOString().split('T')[0];
      (document.getElementById('endDate') as HTMLInputElement).value = today.toISOString().split('T')[0];
      (document.getElementById('expenseDate') as HTMLInputElement).value = today.toISOString().split('T')[0];

      await Promise.all([loadExpenses(), loadCategories(), loadCategoryChart()]);
    }

    async function loadExpenses() {
      allExpenses = await getExpenses();
      renderExpenses(allExpenses);
      updateStats(allExpenses);
    }

    async function loadCategories() {
      categories = await getExpenseCategories();
      const filterSelect = document.getElementById('categoryFilter') as HTMLSelectElement;
      const formSelect = document.getElementById('categoryId') as HTMLSelectElement;
      
      const options = '<option value="">Sin categoría</option>' + 
        categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
      
      filterSelect.innerHTML = '<option value="">Todas</option>' + 
        categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
      formSelect.innerHTML = options;
    }

    async function loadCategoryChart() {
      const data = await getExpensesByCategory();
      const container = document.getElementById('categoryChart')!;
      
      if (data.length === 0) {
        container.innerHTML = '<p class="text-slate-500 text-sm">No hay datos</p>';
        return;
      }

      const maxTotal = Math.max(...data.map(d => d.total));
      container.innerHTML = data.map(cat => `
        <div class="flex items-center">
          <div class="w-24 text-sm text-slate-700 truncate">${cat.name}</div>
          <div class="flex-1 mx-3">
            <div class="w-full bg-slate-200 rounded-full h-3">
              <div class="h-3 rounded-full" style="width: ${(cat.total / maxTotal) * 100}%; background-color: ${cat.color}"></div>
            </div>
          </div>
          <div class="w-24 text-sm font-semibold text-slate-900 text-right">${formatCurrency(cat.total)}</div>
        </div>
      `).join('');
    }

    function renderExpenses(expenses: any[]) {
      const tbody = document.getElementById('expensesTableBody')!;
      
      if (expenses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-slate-500">No hay gastos registrados</td></tr>';
        return;
      }

      tbody.innerHTML = expenses.map(expense => `
        <tr class="hover:bg-slate-50">
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
            ${format(new Date(expense.expense_date), 'dd MMM yyyy', { locale: es })}
          </td>
          <td class="px-6 py-4">
            <div class="text-sm font-medium text-slate-900">${expense.description}</div>
            ${expense.is_recurring ? '<span class="text-xs text-indigo-600">Recurrente</span>' : ''}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            ${expense.category_name ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium" style="background-color: ${expense.category_color}20; color: ${expense.category_color}">${expense.category_name}</span>` : '-'}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${expense.vendor || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-red-600">${formatCurrency(expense.amount)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <button onclick="editExpense('${expense.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Editar</button>
            <button onclick="confirmDelete('${expense.id}')" class="text-red-600 hover:text-red-900">Eliminar</button>
          </td>
        </tr>
      `).join('');
    }

    function updateStats(expenses: any[]) {
      const total = expenses.reduce((sum, e) => sum + e.amount, 0);
      const currentMonth = new Date().getMonth();
      const monthlyTotal = expenses
        .filter(e => new Date(e.expense_date).getMonth() === currentMonth)
        .reduce((sum, e) => sum + e.amount, 0);

      document.getElementById('totalExpenses')!.textContent = formatCurrency(total);
      document.getElementById('monthlyTotal')!.textContent = formatCurrency(monthlyTotal);
      document.getElementById('expenseCount')!.textContent = expenses.length.toString();
    }

    // Modal handlers
    const modal = document.getElementById('expenseModal')!;
    const deleteModal = document.getElementById('deleteModal')!;
    const form = document.getElementById('expenseForm') as HTMLFormElement;

    document.getElementById('addExpenseBtn')?.addEventListener('click', () => {
      document.getElementById('modalTitle')!.textContent = 'Nuevo Gasto';
      form.reset();
      (document.getElementById('expenseId') as HTMLInputElement).value = '';
      (document.getElementById('expenseDate') as HTMLInputElement).value = new Date().toISOString().split('T')[0];
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    });

    document.getElementById('cancelBtn')?.addEventListener('click', () => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    });

    // Recurring toggle
    document.getElementById('isRecurring')?.addEventListener('change', (e) => {
      const freqSelect = document.getElementById('recurringFrequency')!;
      freqSelect.classList.toggle('hidden', !(e.target as HTMLInputElement).checked);
    });

    // Form submit
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const expenseId = (document.getElementById('expenseId') as HTMLInputElement).value;
      const isRecurring = (document.getElementById('isRecurring') as HTMLInputElement).checked;
      
      const expenseData = {
        company_id: currentUser.profile?.company_id,
        description: (document.getElementById('description') as HTMLInputElement).value,
        amount: parseFloat((document.getElementById('amount') as HTMLInputElement).value),
        category_id: (document.getElementById('categoryId') as HTMLSelectElement).value || null,
        vendor: (document.getElementById('vendor') as HTMLInputElement).value || null,
        expense_date: (document.getElementById('expenseDate') as HTMLInputElement).value,
        is_recurring: isRecurring,
        recurring_frequency: isRecurring ? (document.getElementById('recurringFrequency') as HTMLSelectElement).value : null,
        notes: (document.getElementById('notes') as HTMLTextAreaElement).value || null,
        created_by: currentUser.id
      };

      try {
        if (expenseId) {
          await updateExpense(expenseId, expenseData);
        } else {
          await addExpense(expenseData as any);
        }
        
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        await Promise.all([loadExpenses(), loadCategoryChart()]);
      } catch (error) {
        console.error('Error saving expense:', error);
        alert('Error al guardar el gasto');
      }
    });

    // Search
    document.getElementById('searchBtn')?.addEventListener('click', async () => {
      const searchTerm = (document.getElementById('searchInput') as HTMLInputElement).value;
      const startDate = (document.getElementById('startDate') as HTMLInputElement).value;
      const endDate = (document.getElementById('endDate') as HTMLInputElement).value;
      const categoryId = (document.getElementById('categoryFilter') as HTMLSelectElement).value;

      const results = await searchExpenses({
        searchTerm: searchTerm || undefined,
        startDate: startDate || undefined,
        endDate: endDate || undefined,
        categoryId: categoryId || undefined
      });

      renderExpenses(results);
      updateStats(results);
    });

    // Edit and Delete handlers
    (window as any).editExpense = async (id: string) => {
      const expense = allExpenses.find(e => e.id === id);
      if (!expense) return;

      document.getElementById('modalTitle')!.textContent = 'Editar Gasto';
      (document.getElementById('expenseId') as HTMLInputElement).value = expense.id;
      (document.getElementById('description') as HTMLInputElement).value = expense.description;
      (document.getElementById('amount') as HTMLInputElement).value = expense.amount;
      (document.getElementById('categoryId') as HTMLSelectElement).value = expense.category_id || '';
      (document.getElementById('vendor') as HTMLInputElement).value = expense.vendor || '';
      (document.getElementById('expenseDate') as HTMLInputElement).value = expense.expense_date;
      (document.getElementById('isRecurring') as HTMLInputElement).checked = expense.is_recurring;
      (document.getElementById('notes') as HTMLTextAreaElement).value = expense.notes || '';
      
      const freqSelect = document.getElementById('recurringFrequency') as HTMLSelectElement;
      freqSelect.classList.toggle('hidden', !expense.is_recurring);
      if (expense.recurring_frequency) freqSelect.value = expense.recurring_frequency;

      modal.classList.remove('hidden');
      modal.classList.add('flex');
    };

    (window as any).confirmDelete = (id: string) => {
      (document.getElementById('deleteExpenseId') as HTMLInputElement).value = id;
      deleteModal.classList.remove('hidden');
      deleteModal.classList.add('flex');
    };

    document.getElementById('cancelDeleteBtn')?.addEventListener('click', () => {
      deleteModal.classList.add('hidden');
      deleteModal.classList.remove('flex');
    });

    document.getElementById('confirmDeleteBtn')?.addEventListener('click', async () => {
      const id = (document.getElementById('deleteExpenseId') as HTMLInputElement).value;
      try {
        await deleteExpense(id);
        deleteModal.classList.add('hidden');
        deleteModal.classList.remove('flex');
        await Promise.all([loadExpenses(), loadCategoryChart()]);
      } catch (error) {
        console.error('Error deleting expense:', error);
        alert('Error al eliminar el gasto');
      }
    });

    init();
  </script>
</DashboardLayout>
