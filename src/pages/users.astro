---
import DashboardLayout from '../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Usuarios" activeSection="users">
  <div class="px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 class="text-3xl font-bold" style="background: linear-gradient(to right, #f59e0b, #d97706); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Gestión de Usuarios</h1>
        <p class="mt-2 text-slate-600">Administra el equipo de tu empresa</p>
      </div>
      <button id="addUserBtn" class="mt-4 sm:mt-0 btn-primary inline-flex items-center hidden">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
        </svg>
        Nuevo Usuario
      </button>
    </div>

    <!-- Role Legend -->
    <div class="card mb-6 p-4">
      <h3 class="text-sm font-semibold text-slate-700 mb-3">Jerarquía de Roles</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
        <div class="flex items-center space-x-2">
          <span class="w-3 h-3 rounded-full bg-purple-500"></span>
          <span class="text-slate-700"><strong>Super Admin:</strong> Control total</span>
        </div>
        <div class="flex items-center space-x-2">
          <span class="w-3 h-3 rounded-full bg-indigo-500"></span>
          <span class="text-slate-700"><strong>Admin:</strong> Gestión completa</span>
        </div>
        <div class="flex items-center space-x-2">
          <span class="w-3 h-3 rounded-full bg-blue-500"></span>
          <span class="text-slate-700"><strong>Staff:</strong> Operaciones</span>
        </div>
        <div class="flex items-center space-x-2">
          <span class="w-3 h-3 rounded-full bg-slate-400"></span>
          <span class="text-slate-700"><strong>Usuario:</strong> Solo compras</span>
        </div>
      </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
        <p class="text-sm text-slate-600">Total Usuarios</p>
        <p class="text-2xl font-bold text-slate-900" id="totalUsers">0</p>
      </div>
      <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
        <p class="text-sm text-slate-600">Administradores</p>
        <p class="text-2xl font-bold text-indigo-600" id="adminCount">0</p>
      </div>
      <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
        <p class="text-sm text-slate-600">Personal</p>
        <p class="text-2xl font-bold text-blue-600" id="staffCount">0</p>
      </div>
      <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
        <p class="text-sm text-slate-600">Usuarios</p>
        <p class="text-2xl font-bold text-slate-600" id="userCount">0</p>
      </div>
    </div>

    <!-- Users Table -->
    <div class="card">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-200">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Usuario</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Rol</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Estado</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Registro</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody id="usersTableBody" class="bg-white divide-y divide-slate-200">
            <tr>
              <td colspan="5" class="px-6 py-12 text-center text-slate-500">Cargando usuarios...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Add User Modal -->
  <div id="userModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4">
      <div class="p-6 border-b border-slate-200">
        <h2 id="modalTitle" class="text-xl font-bold text-slate-900">Nuevo Usuario</h2>
      </div>
      <form id="userForm" class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Nombre Completo *</label>
          <input type="text" id="fullName" class="input-field w-full" required>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Email *</label>
          <input type="email" id="email" class="input-field w-full" required>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Contraseña *</label>
          <input type="password" id="password" minlength="6" class="input-field w-full" required>
          <p class="text-xs text-slate-500 mt-1">Mínimo 6 caracteres</p>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Rol *</label>
          <select id="role" class="input-field w-full" required>
            <option value="">Seleccionar rol...</option>
          </select>
        </div>
        
        <div class="flex justify-end space-x-3 pt-4">
          <button type="button" id="cancelBtn" class="btn-secondary">Cancelar</button>
          <button type="submit" class="btn-primary">Crear Usuario</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Role Modal -->
  <div id="editModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 p-6">
      <h2 class="text-xl font-bold text-slate-900 mb-4">Cambiar Rol</h2>
      <p class="text-slate-600 mb-4" id="editUserName"></p>
      <input type="hidden" id="editUserId">
      
      <div class="mb-6">
        <label class="block text-sm font-medium text-slate-700 mb-1">Nuevo Rol</label>
        <select id="editRole" class="input-field w-full">
          <option value="">Seleccionar rol...</option>
        </select>
      </div>
      
      <div class="flex justify-end space-x-3">
        <button id="cancelEditBtn" class="btn-secondary">Cancelar</button>
        <button id="confirmEditBtn" class="btn-primary">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Toggle Active Modal -->
  <div id="toggleModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 p-6">
      <h2 class="text-xl font-bold text-slate-900 mb-4" id="toggleTitle">Desactivar Usuario</h2>
      <p class="text-slate-600 mb-6" id="toggleMessage"></p>
      <input type="hidden" id="toggleUserId">
      <input type="hidden" id="toggleAction">
      <div class="flex justify-end space-x-3">
        <button id="cancelToggleBtn" class="btn-secondary">Cancelar</button>
        <button id="confirmToggleBtn" class="btn-danger">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    import { getProfiles, updateProfile, createStaffUser, getCreatableRoles, getRoleLabel } from '../lib/supabase';
    import { checkAuth, isSuperAdmin, isAdmin } from '../lib/auth';
    import { format } from 'date-fns';
    import { es } from 'date-fns/locale';

    let currentUser: any = null;
    let allUsers: any[] = [];
    let creatableRoles: string[] = [];

    const roleColors: Record<string, string> = {
      super_admin: 'bg-purple-100 text-purple-700 border-purple-200',
      admin: 'bg-indigo-100 text-indigo-700 border-indigo-200',
      staff: 'bg-blue-100 text-blue-700 border-blue-200',
      user: 'bg-slate-100 text-slate-700 border-slate-200'
    };

    async function init() {
      currentUser = await checkAuth();
      if (!currentUser) return;

      const userRole = currentUser.profile?.role;
      creatableRoles = getCreatableRoles(userRole);

      // Show add button if user can create users
      if (creatableRoles.length > 0) {
        document.getElementById('addUserBtn')?.classList.remove('hidden');
      }

      // Populate role selects
      const roleSelect = document.getElementById('role') as HTMLSelectElement;
      const editRoleSelect = document.getElementById('editRole') as HTMLSelectElement;
      
      const roleOptions = creatableRoles.map(r => `<option value="${r}">${getRoleLabel(r as any)}</option>`).join('');
      roleSelect.innerHTML = '<option value="">Seleccionar rol...</option>' + roleOptions;
      editRoleSelect.innerHTML = '<option value="">Seleccionar rol...</option>' + roleOptions;

      await loadUsers();
    }

    async function loadUsers() {
      allUsers = await getProfiles();
      renderUsers(allUsers);
      updateStats(allUsers);
    }

    function canEditUser(targetUser: any): boolean {
      const myRole = currentUser.profile?.role;
      const targetRole = targetUser.role;
      
      if (targetUser.id === currentUser.id) return false; // Can't edit yourself
      
      if (myRole === 'super_admin') return targetRole !== 'super_admin';
      if (myRole === 'admin') return ['staff', 'user'].includes(targetRole);
      if (myRole === 'staff') return targetRole === 'user';
      return false;
    }

    function renderUsers(users: any[]) {
      const tbody = document.getElementById('usersTableBody')!;
      
      if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-slate-500">No hay usuarios</td></tr>';
        return;
      }

      tbody.innerHTML = users.map(user => {
        const isMe = user.id === currentUser.id;
        const canEdit = canEditUser(user);
        
        return `
          <tr class="hover:bg-slate-50 ${isMe ? 'bg-indigo-50/50' : ''}">
            <td class="px-6 py-4">
              <div class="flex items-center">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-400 to-blue-600 flex items-center justify-center text-white font-bold text-sm">
                  ${user.full_name?.charAt(0)?.toUpperCase() || '?'}
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium text-slate-900">
                    ${user.full_name || 'Sin nombre'}
                    ${isMe ? '<span class="text-xs text-indigo-600 ml-2">(Tú)</span>' : ''}
                  </div>
                  <div class="text-sm text-slate-500">${user.email || ''}</div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4">
              <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border ${roleColors[user.role] || roleColors.user}">
                ${getRoleLabel(user.role)}
              </span>
            </td>
            <td class="px-6 py-4">
              ${user.is_active !== false 
                ? '<span class="badge-success">Activo</span>' 
                : '<span class="badge-danger">Inactivo</span>'}
            </td>
            <td class="px-6 py-4 text-sm text-slate-500">
              ${user.created_at ? format(new Date(user.created_at), 'dd MMM yyyy', { locale: es }) : '-'}
            </td>
            <td class="px-6 py-4 text-sm">
              ${canEdit ? `
                <button onclick="editUserRole('${user.id}', '${user.full_name}', '${user.role}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Cambiar Rol</button>
                <button onclick="toggleUserActive('${user.id}', '${user.full_name}', ${user.is_active !== false})" class="${user.is_active !== false ? 'text-red-600 hover:text-red-900' : 'text-green-600 hover:text-green-900'}">
                  ${user.is_active !== false ? 'Desactivar' : 'Activar'}
                </button>
              ` : '<span class="text-slate-400">-</span>'}
            </td>
          </tr>
        `;
      }).join('');
    }

    function updateStats(users: any[]) {
      const total = users.length;
      const admins = users.filter(u => ['super_admin', 'admin'].includes(u.role)).length;
      const staff = users.filter(u => u.role === 'staff').length;
      const regularUsers = users.filter(u => u.role === 'user').length;

      document.getElementById('totalUsers')!.textContent = total.toString();
      document.getElementById('adminCount')!.textContent = admins.toString();
      document.getElementById('staffCount')!.textContent = staff.toString();
      document.getElementById('userCount')!.textContent = regularUsers.toString();
    }

    // Add User Modal
    const modal = document.getElementById('userModal')!;
    const form = document.getElementById('userForm') as HTMLFormElement;

    document.getElementById('addUserBtn')?.addEventListener('click', () => {
      form.reset();
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    });

    document.getElementById('cancelBtn')?.addEventListener('click', () => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    });

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const fullName = (document.getElementById('fullName') as HTMLInputElement).value;
      const email = (document.getElementById('email') as HTMLInputElement).value;
      const password = (document.getElementById('password') as HTMLInputElement).value;
      const role = (document.getElementById('role') as HTMLSelectElement).value;

      if (!creatableRoles.includes(role)) {
        alert('No tienes permisos para crear usuarios con ese rol');
        return;
      }

      try {
        const { error } = await createStaffUser(email, password, fullName, currentUser.profile?.company_id, role as any);
        
        if (error) {
          alert('Error al crear usuario: ' + error.message);
          return;
        }
        
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        await loadUsers();
        alert('Usuario creado correctamente. Debe verificar su email para acceder.');
      } catch (error) {
        console.error('Error creating user:', error);
        alert('Error al crear el usuario');
      }
    });

    // Edit Role Modal
    const editModal = document.getElementById('editModal')!;

    (window as any).editUserRole = (id: string, name: string, currentRole: string) => {
      document.getElementById('editUserName')!.textContent = `Usuario: ${name}`;
      (document.getElementById('editUserId') as HTMLInputElement).value = id;
      (document.getElementById('editRole') as HTMLSelectElement).value = currentRole;
      editModal.classList.remove('hidden');
      editModal.classList.add('flex');
    };

    document.getElementById('cancelEditBtn')?.addEventListener('click', () => {
      editModal.classList.add('hidden');
      editModal.classList.remove('flex');
    });

    document.getElementById('confirmEditBtn')?.addEventListener('click', async () => {
      const id = (document.getElementById('editUserId') as HTMLInputElement).value;
      const newRole = (document.getElementById('editRole') as HTMLSelectElement).value;

      if (!creatableRoles.includes(newRole)) {
        alert('No tienes permisos para asignar ese rol');
        return;
      }

      try {
        await updateProfile(id, { role: newRole as any });
        editModal.classList.add('hidden');
        editModal.classList.remove('flex');
        await loadUsers();
      } catch (error) {
        console.error('Error updating role:', error);
        alert('Error al cambiar el rol');
      }
    });

    // Toggle Active Modal
    const toggleModal = document.getElementById('toggleModal')!;

    (window as any).toggleUserActive = (id: string, name: string, isActive: boolean) => {
      document.getElementById('toggleTitle')!.textContent = isActive ? 'Desactivar Usuario' : 'Activar Usuario';
      document.getElementById('toggleMessage')!.textContent = isActive 
        ? `¿Estás seguro de que quieres desactivar a ${name}? No podrá acceder al sistema.`
        : `¿Quieres reactivar el acceso de ${name} al sistema?`;
      (document.getElementById('toggleUserId') as HTMLInputElement).value = id;
      (document.getElementById('toggleAction') as HTMLInputElement).value = isActive ? 'deactivate' : 'activate';
      
      const confirmBtn = document.getElementById('confirmToggleBtn')!;
      confirmBtn.className = isActive ? 'btn-danger' : 'btn-primary';
      confirmBtn.textContent = isActive ? 'Desactivar' : 'Activar';
      
      toggleModal.classList.remove('hidden');
      toggleModal.classList.add('flex');
    };

    document.getElementById('cancelToggleBtn')?.addEventListener('click', () => {
      toggleModal.classList.add('hidden');
      toggleModal.classList.remove('flex');
    });

    document.getElementById('confirmToggleBtn')?.addEventListener('click', async () => {
      const id = (document.getElementById('toggleUserId') as HTMLInputElement).value;
      const action = (document.getElementById('toggleAction') as HTMLInputElement).value;

      try {
        await updateProfile(id, { is_active: action === 'activate' });
        toggleModal.classList.add('hidden');
        toggleModal.classList.remove('flex');
        await loadUsers();
      } catch (error) {
        console.error('Error toggling user:', error);
        alert('Error al cambiar el estado del usuario');
      }
    });

    init();
  </script>
</DashboardLayout>
