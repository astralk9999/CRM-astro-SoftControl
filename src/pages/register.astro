---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Registro - SoftControl">
  <div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 bg-gradient-to-br from-slate-50 via-indigo-50/30 to-slate-100 dark:from-slate-900 dark:via-indigo-950/20 dark:to-slate-900">
    <div class="max-w-lg w-full">
      <!-- Logo y título -->
      <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-xl shadow-indigo-500/10 mb-6">
          <img src="/images/logo-icon.png" alt="SoftControl" class="h-16 w-16 rounded-xl" />
        </div>
        <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Crear tu cuenta</h2>
        <p class="mt-2 text-slate-500 dark:text-slate-400">Regístrate para acceder a SoftControl</p>
      </div>

      <!-- Card del formulario -->
      <div class="bg-white dark:bg-slate-800/50 rounded-2xl border border-slate-200/80 dark:border-slate-700/50 shadow-xl shadow-slate-200/50 dark:shadow-none overflow-hidden">
        <form id="registerForm" class="p-8 space-y-6">
          <!-- Plan Selection -->
          <div id="planInfo" class="bg-indigo-50 dark:bg-indigo-900/30 border border-indigo-100 dark:border-indigo-800 rounded-xl p-4 hidden">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-indigo-600 dark:text-indigo-400 font-medium">Plan seleccionado</p>
                <p id="selectedPlan" class="text-lg font-bold text-indigo-800 dark:text-indigo-300"></p>
              </div>
              <div class="text-right">
                <p id="planPrice" class="text-2xl font-bold text-indigo-600 dark:text-indigo-400"></p>
              </div>
            </div>
          </div>

          <div class="space-y-4">
            <div>
              <label for="registerName" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Nombre completo *</label>
              <input
                id="registerName"
                name="fullName"
                type="text"
                required
                class="input-field w-full"
                placeholder="Juan Pérez"
              />
            </div>
            <div>
              <label for="registerEmail" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Correo electrónico *</label>
              <input
                id="registerEmail"
                name="email"
                type="email"
                autocomplete="email"
                required
                class="input-field w-full"
                placeholder="tu@email.com"
              />
            </div>
            <div>
              <label for="companyName" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Empresa (opcional)</label>
              <input
                id="companyName"
                name="companyName"
                type="text"
                class="input-field w-full"
                placeholder="Nombre de tu empresa"
              />
            </div>
            <div>
              <label for="registerPassword" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Contraseña *</label>
              <input
                id="registerPassword"
                name="password"
                type="password"
                autocomplete="new-password"
                required
                class="input-field w-full"
                placeholder="Mínimo 6 caracteres"
              />
            </div>
          </div>

          <div id="registerErrorMessage" class="hidden bg-rose-50 border border-rose-200 text-rose-700 px-4 py-3 rounded-lg text-sm"></div>
          <div id="registerSuccessMessage" class="hidden bg-emerald-50 border border-emerald-200 text-emerald-700 px-4 py-3 rounded-lg text-sm"></div>

          <button
            type="submit"
            id="submitBtn"
            class="btn-primary w-full"
          >
            Crear cuenta
          </button>

          <p class="text-xs text-slate-500 dark:text-slate-400 text-center">
            Al registrarte aceptas nuestros términos y condiciones.
          </p>

          <div class="text-sm text-center pt-4 border-t border-slate-100 dark:border-slate-700">
            <span class="text-slate-600 dark:text-slate-400">¿Ya tienes cuenta?</span>
            <a href="/login" class="ml-1 font-medium text-indigo-600 hover:text-indigo-500 transition-colors">
              Inicia sesión aquí
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    import { signUpCustomer, addSubscription, addLicense, supabase } from '../lib/supabase';
    import { checkAuth } from '../lib/auth';

    // Enlaces de Stripe Payment Links
    const STRIPE_LINKS: Record<string, string> = {
      monthly: 'https://buy.stripe.com/test_9B6cMY6Oz9rqbYTcco08g00',
      annual: 'https://buy.stripe.com/test_5kQ14g1uf476fb51xK08g02',
      lifetime: 'https://buy.stripe.com/test_eVq14g7SD7ji6EzgsE08g01'
    };

    const planLabels: Record<string, string> = {
      trial: 'Prueba Gratuita',
      monthly: 'Plan Mensual',
      annual: 'Plan Anual',
      lifetime: 'Licencia Definitiva'
    };

    const planPrices: Record<string, string> = {
      trial: '14 días gratis',
      monthly: '9,99€/mes',
      annual: '99,99€/año',
      lifetime: '199,99€'
    };

    const planDurations: Record<string, number> = {
      trial: 14,
      monthly: 30,
      annual: 365,
      lifetime: 36500 // ~100 years
    };

    // Check for plan in URL
    const urlParams = new URLSearchParams(window.location.search);
    const selectedPlanParam = urlParams.get('plan');
    
    if (selectedPlanParam && planLabels[selectedPlanParam]) {
      const planInfo = document.getElementById('planInfo');
      const planLabel = document.getElementById('selectedPlan');
      const planPrice = document.getElementById('planPrice');
      const submitBtn = document.getElementById('submitBtn');
      
      if (planInfo && planLabel && planPrice) {
        planLabel.textContent = planLabels[selectedPlanParam];
        planPrice.textContent = planPrices[selectedPlanParam];
        planInfo.classList.remove('hidden');
      }
      if (submitBtn) {
        submitBtn.textContent = 'Crear cuenta y continuar al pago';
      }
    }

    // Si ya está autenticado, redirigir
    async function checkIfAuthenticated() {
      const user = await checkAuth();
      if (user) {
        if (user.userType === 'staff') {
          window.location.href = '/dashboard';
        } else {
          window.location.href = '/mi-cuenta';
        }
      }
    }

    checkIfAuthenticated();

    const registerForm = document.getElementById('registerForm');

    registerForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const nameInput = document.getElementById('registerName') as HTMLInputElement;
      const emailInput = document.getElementById('registerEmail') as HTMLInputElement;
      const companyInput = document.getElementById('companyName') as HTMLInputElement;
      const passwordInput = document.getElementById('registerPassword') as HTMLInputElement;
      const errorMessage = document.getElementById('registerErrorMessage');
      const successMessage = document.getElementById('registerSuccessMessage');
      const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;

      if (!nameInput || !emailInput || !passwordInput) {
        return;
      }

      const fullName = nameInput.value.trim();
      const email = emailInput.value.trim();
      const companyName = companyInput?.value.trim() || undefined;
      const password = passwordInput.value;

      if (errorMessage) errorMessage.classList.add('hidden');
      if (successMessage) successMessage.classList.add('hidden');

      if (password.length < 6) {
        if (errorMessage) {
          errorMessage.textContent = 'La contraseña debe tener al menos 6 caracteres';
          errorMessage.classList.remove('hidden');
        }
        return;
      }

      // Disable button
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Creando cuenta...';
      }

      try {
        console.log('Starting registration for:', email);
        const { error, customerId } = await signUpCustomer(email, password, fullName, companyName);
        console.log('SignUp result - customerId:', customerId, 'error:', error);

        if (error) {
          if (errorMessage) {
            errorMessage.textContent = error.message || 'Error al registrar';
            errorMessage.classList.remove('hidden');
          }
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = selectedPlanParam ? 'Crear cuenta y continuar al pago' : 'Crear cuenta';
          }
          return;
        }

        if (successMessage) {
          successMessage.textContent = '¡Cuenta creada! Redirigiendo...';
          successMessage.classList.remove('hidden');
        }

        // Determine plan type
        const isTrial = selectedPlanParam === 'trial';
        const isPaid = selectedPlanParam && ['monthly', 'annual', 'lifetime'].includes(selectedPlanParam);
        
        // Try to create subscription if we have customer ID
        if (customerId && selectedPlanParam) {
          const endDate = new Date();
          endDate.setDate(endDate.getDate() + (planDurations[selectedPlanParam] || 14));
          
          console.log('Creating subscription for plan:', selectedPlanParam, 'customer:', customerId);
          
          try {
            const subscriptionData = {
              customer_id: customerId,
              product_id: null,
              subscription_type: selectedPlanParam as 'trial' | 'monthly' | 'annual' | 'lifetime',
              status: isTrial ? 'trial' : 'pending',
              start_date: new Date().toISOString().split('T')[0],
              end_date: endDate.toISOString().split('T')[0],
              trial_ends_at: isTrial ? endDate.toISOString() : null,
              auto_renew: selectedPlanParam === 'monthly' || selectedPlanParam === 'annual',
              payment_status: 'pending',
              amount: isTrial ? 0 : (selectedPlanParam === 'monthly' ? 9.99 : selectedPlanParam === 'annual' ? 99.99 : 199.99),
              currency: 'EUR'
            };
            
            const { data: subData, error: subError } = await addSubscription(subscriptionData as any);
            console.log('Subscription result:', subData, subError);

            // If trial, also create a trial license
            if (isTrial && !subError) {
              const generateLicenseKey = () => {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                const parts = [];
                for (let i = 0; i < 4; i++) {
                  let part = '';
                  for (let j = 0; j < 4; j++) {
                    part += chars.charAt(Math.floor(Math.random() * chars.length));
                  }
                  parts.push(part);
                }
                return 'TRIAL-' + parts.join('-');
              };

              const { error: licError } = await addLicense({
                customer_id: customerId,
                subscription_id: subData?.id || null,
                product_id: null,
                license_key: generateLicenseKey(),
                status: 'active',
                activation_date: new Date().toISOString().split('T')[0],
                expiration_date: endDate.toISOString().split('T')[0],
                max_activations: 1,
                current_activations: 1,
                last_check_in: new Date().toISOString(),
                hardware_id: null,
                metadata: { type: 'trial', created_from: 'register' }
              } as any);

              if (licError) {
                console.error('License error:', licError);
              } else {
                console.log('Trial license created');
              }
            }
          } catch (subErr) {
            console.error('Subscription error:', subErr);
          }
        }
        
        // ALWAYS redirect based on plan type (even if subscription failed)
        if (isTrial) {
          if (successMessage) {
            successMessage.textContent = '¡Prueba gratuita activada! Tienes 14 días para explorar.';
          }
          setTimeout(() => {
            window.location.href = '/login';
          }, 2000);
        } else if (isPaid) {
          const stripeUrl = STRIPE_LINKS[selectedPlanParam!];
          if (stripeUrl) {
            if (successMessage) {
              successMessage.textContent = '¡Cuenta creada! Redirigiendo a Stripe...';
            }
            const finalUrl = `${stripeUrl}?prefilled_email=${encodeURIComponent(email)}`;
            console.log('Redirecting to Stripe:', finalUrl);
            // Redirect immediately
            window.location.href = finalUrl;
          } else {
            console.error('No Stripe link for plan:', selectedPlanParam);
            setTimeout(() => window.location.href = '/login', 2000);
          }
        } else {
          // No plan selected
          setTimeout(() => {
            window.location.href = '/login';
          }, 2000);
        }
      } catch (err) {
        if (errorMessage) {
          errorMessage.textContent = 'Error al registrar. Por favor, intenta de nuevo.';
          errorMessage.classList.remove('hidden');
        }
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = selectedPlanParam ? 'Crear cuenta y continuar al pago' : 'Crear cuenta';
        }
      }
    });
  </script>
</Layout>
