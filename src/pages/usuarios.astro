---
import DashboardLayout from '../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Gesti√≥n de Usuarios" activeSection="usuarios">
  <!-- Loading Screen -->
  <div id="loadingScreen" class="flex items-center justify-center min-h-[60vh]">
    <div class="text-center">
      <div class="w-12 h-12 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center mx-auto">
        <svg class="w-6 h-6 text-indigo-500 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </div>
      <p class="mt-4 text-slate-600 dark:text-slate-400">Cargando...</p>
    </div>
  </div>

  <!-- Access Denied -->
  <div id="accessDenied" class="hidden flex items-center justify-center min-h-[60vh]">
    <div class="text-center">
      <div class="w-20 h-20 mx-auto rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center mb-4">
        <svg class="h-10 w-10 text-red-500 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
        </svg>
      </div>
      <h2 class="text-xl font-bold text-slate-900 dark:text-white">Acceso Denegado</h2>
      <p class="mt-2 text-slate-600 dark:text-slate-400">Solo Super Admin puede acceder a esta p√°gina</p>
      <a href="/dashboard" class="mt-4 inline-block btn-primary">Volver al Dashboard</a>
    </div>
  </div>

  <!-- Main Content -->
  <div id="mainContent" class="hidden px-4 sm:px-6 lg:px-8 py-6 space-y-6">
    <!-- Header -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
      <div class="flex items-center gap-4">
        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-slate-600 via-slate-700 to-slate-800 flex items-center justify-center shadow-lg shadow-slate-500/30">
          <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
          </svg>
        </div>
        <div>
          <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Equipo &amp; Staff</h1>
          <p class="text-slate-500 dark:text-slate-400 text-sm">Gestiona permisos, roles y acceso del personal</p>
        </div>
      </div>
      <button onclick="openAddStaffModal()" class="btn-primary inline-flex items-center gap-2 shadow-lg shadow-indigo-500/25 hover:shadow-indigo-500/40 transition-all">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        A√±adir Staff
      </button>
    </div>

    <!-- Filters -->
    <div class="bg-white dark:bg-slate-800/50 rounded-2xl border border-slate-200/80 dark:border-slate-700/50 p-4">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="lg:col-span-2">
          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1.5">Buscar</label>
          <div class="relative">
            <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 dark:text-slate-500 pointer-events-none z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input type="text" id="staffSearch" class="input-field w-full pl-10" placeholder="Nombre, email o rol...">
          </div>
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1.5">Rol</label>
          <select id="roleFilter" class="input-field w-full">
            <option value="all">Todos los roles</option>
            <option value="super_admin">üëë Super Admin</option>
            <option value="admin">üõ†Ô∏è Administrador</option>
            <option value="staff">üë§ Staff</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1.5">Estado</label>
          <select id="activeFilter" class="input-field w-full">
            <option value="all">Todos</option>
            <option value="active">‚úÖ Solo activos</option>
            <option value="inactive">‚ùå Solo inactivos</option>
          </select>
        </div>
      </div>
      <div class="flex items-center justify-between mt-4 pt-4 border-t border-slate-100 dark:border-slate-700/50">
        <div class="flex gap-6">
          <div>
            <p class="text-xs text-slate-500 dark:text-slate-400">Staff total</p>
            <p class="text-xl font-bold text-slate-900 dark:text-white"><span id="staffTotal">0</span></p>
          </div>
          <div>
            <p class="text-xs text-slate-500 dark:text-slate-400">Mostrando</p>
            <p class="text-xl font-bold text-indigo-600 dark:text-indigo-400"><span id="staffVisible">0</span></p>
          </div>
        </div>
        <button id="clearFilters" class="text-sm text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 font-medium">Limpiar filtros</button>
      </div>
    </div>

    <!-- Staff Table -->
    <div id="staffSection" class="card overflow-hidden">
      <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
        <thead class="bg-slate-50 dark:bg-slate-900/40">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 dark:text-slate-300 uppercase tracking-wider">Usuario</th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 dark:text-slate-300 uppercase tracking-wider">Rol</th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 dark:text-slate-300 uppercase tracking-wider">Estado</th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 dark:text-slate-300 uppercase tracking-wider">Creado</th>
            <th class="px-6 py-3 text-right text-xs font-semibold text-slate-500 dark:text-slate-300 uppercase tracking-wider">Acciones</th>
          </tr>
        </thead>
        <tbody id="staffTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700"></tbody>
      </table>
    </div>
  </div>

  <!-- Add/Edit Staff Modal -->
  <div id="staffModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl max-w-md w-full p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 id="staffModalTitle" class="text-xl font-bold text-slate-900 dark:text-white">A√±adir Staff</h3>
        <button onclick="closeStaffModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <form id="staffForm" class="space-y-4">
        <input type="hidden" id="staffId" value="">
        
        <div>
          <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Email *</label>
          <input type="email" id="staffEmail" required class="input w-full" placeholder="email@ejemplo.com">
        </div>
        
        <div id="passwordField">
          <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Contrase√±a *</label>
          <input type="password" id="staffPassword" class="input w-full" placeholder="M√≠nimo 6 caracteres">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Nombre completo *</label>
          <input type="text" id="staffName" required class="input w-full" placeholder="Nombre Apellido">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Rol *</label>
          <select id="staffRole" required class="input w-full">
            <option value="staff">Staff</option>
            <option value="admin">Administrador</option>
            <option value="super_admin">Super Admin</option>
          </select>
        </div>
        
        <div class="flex items-center gap-2">
          <input type="checkbox" id="staffActive" checked class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
          <label for="staffActive" class="text-sm text-slate-700 dark:text-slate-300">Usuario activo</label>
        </div>
        
        <div id="staffError" class="hidden text-red-600 text-sm"></div>
        
        <div class="flex gap-3 pt-4">
          <button type="button" onclick="closeStaffModal()" class="btn-secondary flex-1">Cancelar</button>
          <button type="submit" id="staffSubmitBtn" class="btn-primary flex-1">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  </DashboardLayout>

<script>
  import { supabase, getRoleLabel, getCreatableRoles, canEditRole, canDeleteRole } from '../lib/supabase';
  import type { UserRole } from '../lib/supabase';
  import { checkAuth, isSuperAdmin } from '../lib/auth';
  import { format } from 'date-fns';
  import { es } from 'date-fns/locale';

  let staffList: any[] = [];
  let filteredStaff: any[] = [];
  let currentUser: any = null;
  let creatableRoles: UserRole[] = [];

  async function init() {
    const loadingScreen = document.getElementById('loadingScreen');
    const accessDenied = document.getElementById('accessDenied');
    const mainContent = document.getElementById('mainContent');

    currentUser = await checkAuth();

    if (!currentUser || !isSuperAdmin(currentUser)) {
      if (loadingScreen) loadingScreen.classList.add('hidden');
      if (accessDenied) accessDenied.classList.remove('hidden');
      return;
    }

    // Get roles this user can create
    const myRole = currentUser.profile?.role as UserRole;
    creatableRoles = getCreatableRoles(myRole);
    
    // Update role select options
    updateRoleSelect();

    await loadStaff();

    if (loadingScreen) loadingScreen.classList.add('hidden');
    if (mainContent) mainContent.classList.remove('hidden');
  }
  
  function updateRoleSelect() {
    const roleSelect = document.getElementById('staffRole') as HTMLSelectElement;
    if (roleSelect && creatableRoles.length > 0) {
      roleSelect.innerHTML = creatableRoles
        .map(r => `<option value="${r}">${getRoleLabel(r)}</option>`)
        .join('');
    }
  }

  async function loadStaff() {
    const { data, error } = await supabase
      .from('profiles')
      .select('*')
      .order('created_at', { ascending: false });

    if (data) {
      staffList = data;
      const totalEl = document.getElementById('staffTotal');
      if (totalEl) totalEl.textContent = data.length.toString();
      applyStaffFilters();
    }
  }

  function applyStaffFilters() {
    const searchValue = (document.getElementById('staffSearch') as HTMLInputElement)?.value?.toLowerCase() || '';
    const role = (document.getElementById('roleFilter') as HTMLSelectElement)?.value || 'all';
    const activeStatus = (document.getElementById('activeFilter') as HTMLSelectElement)?.value || 'all';

    filteredStaff = staffList.filter((staff) => {
      const matchesSearch = !searchValue || staff.full_name?.toLowerCase().includes(searchValue) || staff.email?.toLowerCase().includes(searchValue) || getRoleLabel(staff.role)?.toLowerCase().includes(searchValue);
      const matchesRole = role === 'all' || staff.role === role;
      const matchesActive = activeStatus === 'all' || (activeStatus === 'active' && staff.is_active) || (activeStatus === 'inactive' && !staff.is_active);
      return matchesSearch && matchesRole && matchesActive;
    });

    renderStaffTable();
    const visibleEl = document.getElementById('staffVisible');
    if (visibleEl) visibleEl.textContent = filteredStaff.length.toString();
  }

  function renderStaffTable() {
    const tbody = document.getElementById('staffTableBody');
    if (!tbody) return;

    if (filteredStaff.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">
            No hay staff registrado con ese filtro
          </td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = filteredStaff.map(staff => `
      <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
        <td class="px-6 py-4">
          <div class="flex items-center">
            <div class="h-10 w-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold">
              ${staff.full_name?.charAt(0)?.toUpperCase() || 'U'}
            </div>
            <div class="ml-4">
              <div class="font-medium text-slate-900 dark:text-white">${staff.full_name || 'Sin nombre'}</div>
              <div class="text-sm text-slate-500 dark:text-slate-400">${staff.email || ''}</div>
            </div>
          </div>
        </td>
        <td class="px-6 py-4">
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getRoleBadgeClass(staff.role)}">
            ${getRoleLabel(staff.role)}
          </span>
        </td>
        <td class="px-6 py-4">
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${staff.is_active ? 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400' : 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400'}">
            ${staff.is_active ? 'Activo' : 'Inactivo'}
          </span>
        </td>
        <td class="px-6 py-4 text-sm text-slate-500 dark:text-slate-400">
          ${staff.created_at ? format(new Date(staff.created_at), 'dd MMM yyyy', { locale: es }) : '-'}
        </td>
        <td class="px-6 py-4 text-right">
          <button onclick="editStaff('${staff.id}')" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 mr-3">
            Editar
          </button>
          ${staff.id !== currentUser?.id ? `
            <button onclick="deleteStaff('${staff.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
              Eliminar
            </button>
          ` : ''}
        </td>
      </tr>
    `).join('');
  }

  function getRoleBadgeClass(role: string): string {
    const classes: Record<string, string> = {
      super_admin: 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400',
      admin: 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900/30 dark:text-indigo-400',
      staff: 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400'
    };
    return classes[role] || classes.staff;
  }

  // Staff Modal Functions
  (window as any).openAddStaffModal = () => {
    const modal = document.getElementById('staffModal');
    const title = document.getElementById('staffModalTitle');
    const form = document.getElementById('staffForm') as HTMLFormElement;
    const passwordField = document.getElementById('passwordField');
    
    if (title) title.textContent = 'A√±adir Staff';
    if (passwordField) passwordField.classList.remove('hidden');
    form?.reset();
    (document.getElementById('staffId') as HTMLInputElement).value = '';
    (document.getElementById('staffActive') as HTMLInputElement).checked = true;
    modal?.classList.remove('hidden');
  };

  (window as any).editStaff = (id: string) => {
    const staff = staffList.find(s => s.id === id);
    if (!staff) return;

    const modal = document.getElementById('staffModal');
    const title = document.getElementById('staffModalTitle');
    const passwordField = document.getElementById('passwordField');

    if (title) title.textContent = 'Editar Staff';
    if (passwordField) passwordField.classList.add('hidden');

    (document.getElementById('staffId') as HTMLInputElement).value = staff.id;
    (document.getElementById('staffEmail') as HTMLInputElement).value = staff.email || '';
    (document.getElementById('staffName') as HTMLInputElement).value = staff.full_name || '';
    (document.getElementById('staffRole') as HTMLSelectElement).value = staff.role;
    (document.getElementById('staffActive') as HTMLInputElement).checked = staff.is_active;

    modal?.classList.remove('hidden');
  };

  (window as any).closeStaffModal = () => {
    document.getElementById('staffModal')?.classList.add('hidden');
    document.getElementById('staffError')?.classList.add('hidden');
  };

  (window as any).deleteStaff = async (id: string) => {
    if (!confirm('¬øEliminar este usuario del staff?')) return;

    const { error } = await supabase.from('profiles').delete().eq('id', id);
    
    if (error) {
      alert('Error al eliminar: ' + error.message);
    } else {
      await loadStaff();
    }
  };

  // Form Submissions
  document.getElementById('staffForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const errorEl = document.getElementById('staffError');
    const submitBtn = document.getElementById('staffSubmitBtn') as HTMLButtonElement;
    
    const id = (document.getElementById('staffId') as HTMLInputElement).value;
    const email = (document.getElementById('staffEmail') as HTMLInputElement).value;
    const password = (document.getElementById('staffPassword') as HTMLInputElement).value;
    const fullName = (document.getElementById('staffName') as HTMLInputElement).value;
    const role = (document.getElementById('staffRole') as HTMLSelectElement).value;
    const isActive = (document.getElementById('staffActive') as HTMLInputElement).checked;

    submitBtn.disabled = true;
    submitBtn.textContent = 'Guardando...';

    try {
      if (id) {
        // Update existing
        const { error } = await supabase
          .from('profiles')
          .update({ full_name: fullName, role, is_active: isActive })
          .eq('id', id);

        if (error) throw error;
      } else {
        // Create new staff using API endpoint with admin privileges
        if (password.length < 6) {
          throw new Error('La contrase√±a debe tener al menos 6 caracteres');
        }

        const response = await fetch('/api/create-staff', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email,
            password,
            fullName,
            role
          })
        });

        const result = await response.json();

        if (!response.ok || result.error) {
          throw new Error(result.error || 'Error al crear usuario');
        }
      }

      (window as any).closeStaffModal();
      await loadStaff();
    } catch (err: any) {
      if (errorEl) {
        errorEl.textContent = err.message || 'Error al guardar';
        errorEl.classList.remove('hidden');
      }
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Guardar';
    }
  });

  document.getElementById('staffSearch')?.addEventListener('input', applyStaffFilters);
  document.getElementById('roleFilter')?.addEventListener('change', applyStaffFilters);
  document.getElementById('activeFilter')?.addEventListener('change', applyStaffFilters);
  
  document.getElementById('clearFilters')?.addEventListener('click', () => {
    (document.getElementById('staffSearch') as HTMLInputElement).value = '';
    (document.getElementById('roleFilter') as HTMLSelectElement).value = 'all';
    (document.getElementById('activeFilter') as HTMLSelectElement).value = 'all';
    applyStaffFilters();
  });

  init();
</script>
