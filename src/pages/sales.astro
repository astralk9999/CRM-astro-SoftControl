---
import DashboardLayout from '../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Ventas" activeSection="sales">
  <div class="px-4 sm:px-6 lg:px-8 py-6">
    <!-- Header -->
    <div class="mb-6 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
      <div class="flex items-center gap-4">
        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-emerald-500 via-green-500 to-teal-600 flex items-center justify-center shadow-lg shadow-emerald-500/30">
          <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <div>
          <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Ventas</h1>
          <p class="text-slate-500 dark:text-slate-400 text-sm">Gestiona todas las ventas de tu empresa</p>
        </div>
      </div>
      <button id="addSaleBtn" class="btn-primary inline-flex items-center gap-2 shadow-lg shadow-indigo-500/25 hover:shadow-indigo-500/40 transition-all">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        Nueva Venta
      </button>
    </div>

    <!-- Stats Summary -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="relative overflow-hidden bg-gradient-to-br from-slate-600 to-slate-800 rounded-2xl p-5 text-white shadow-lg">
        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white/10 rounded-full blur-2xl"></div>
        <div class="relative">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-5 h-5 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            <span class="text-sm font-medium text-white/80">Total Ventas</span>
          </div>
          <p id="totalSalesCount" class="text-3xl font-bold">0</p>
        </div>
      </div>
      <div class="relative overflow-hidden bg-gradient-to-br from-emerald-500 to-green-600 rounded-2xl p-5 text-white shadow-lg shadow-emerald-500/20">
        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white/10 rounded-full blur-2xl"></div>
        <div class="relative">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-5 h-5 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span class="text-sm font-medium text-white/80">Ingresos Totales</span>
          </div>
          <p id="totalSalesAmount" class="text-3xl font-bold">0 ‚Ç¨</p>
        </div>
      </div>
      <div class="relative overflow-hidden bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-5 text-white shadow-lg shadow-blue-500/20">
        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white/10 rounded-full blur-2xl"></div>
        <div class="relative">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-5 h-5 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span class="text-sm font-medium text-white/80">Pagadas</span>
          </div>
          <p id="paidSalesCount" class="text-3xl font-bold">0</p>
        </div>
      </div>
      <div class="relative overflow-hidden bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-5 text-white shadow-lg shadow-amber-500/20">
        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white/10 rounded-full blur-2xl"></div>
        <div class="relative">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-5 h-5 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span class="text-sm font-medium text-white/80">Pendientes</span>
          </div>
          <p id="pendingSalesCount" class="text-3xl font-bold">0</p>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="mb-6">
      <div class="bg-white dark:bg-slate-800/50 rounded-2xl border border-slate-200/80 dark:border-slate-700/50 p-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4">
          <div class="lg:col-span-2">
            <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1.5">Buscar</label>
            <div class="relative">
              <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 dark:text-slate-500 pointer-events-none z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
              <input type="text" id="searchInput" placeholder="Cliente, producto o factura..." class="input-field w-full pl-10">
            </div>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1.5">Desde</label>
            <input type="date" id="startDate" class="input-field w-full">
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1.5">Hasta</label>
            <input type="date" id="endDate" class="input-field w-full">
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1.5">Estado</label>
            <select id="statusFilter" class="input-field w-full">
              <option value="">Todos</option>
              <option value="paid">‚úÖ Pagado</option>
              <option value="pending">‚è≥ Pendiente</option>
              <option value="cancelled">‚ùå Cancelado</option>
              <option value="refunded">‚Ü©Ô∏è Reembolsado</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1.5">M√©todo</label>
            <select id="methodFilter" class="input-field w-full">
              <option value="">Todos</option>
              <option value="card">üí≥ Tarjeta</option>
              <option value="transfer">üè¶ Transferencia</option>
              <option value="paypal">PayPal</option>
              <option value="cash">üíµ Efectivo</option>
            </select>
          </div>
        </div>
        <div class="flex items-center justify-between mt-4 pt-4 border-t border-slate-100 dark:border-slate-700/50">
          <p class="text-sm text-slate-500 dark:text-slate-400"><span id="filteredCount" class="font-semibold text-slate-700 dark:text-slate-300">0</span> ventas encontradas</p>
          <div class="flex gap-3">
            <button id="clearFilters" class="text-sm text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 font-medium transition-colors">Limpiar</button>
            <button id="searchBtn" class="btn-primary text-sm">Buscar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sales Table -->
    <div class="bg-white dark:bg-slate-800/50 rounded-2xl border border-slate-200/80 dark:border-slate-700/50 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700/50">
          <thead class="bg-slate-50/80 dark:bg-slate-900/50">
            <tr>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase tracking-wider">Fecha</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase tracking-wider">Cliente</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase tracking-wider">Producto</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase tracking-wider">Tipo</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase tracking-wider">Total</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase tracking-wider">Estado</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody id="salesTableBody" class="divide-y divide-slate-100 dark:divide-slate-700/50">
            <tr>
              <td colspan="7" class="px-6 py-12 text-center text-slate-500 dark:text-slate-400">
                <div class="flex flex-col items-center gap-3">
                  <div class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center">
                    <svg class="w-5 h-5 text-slate-400 animate-spin" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                  </div>
                  <span>Cargando ventas...</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Add/Edit Sale Modal -->
  <div id="saleModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-slate-200 dark:border-slate-700">
        <h2 id="modalTitle" class="text-xl font-bold text-slate-900 dark:text-white">Nueva Venta</h2>
      </div>
      <form id="saleForm" class="p-6 space-y-4">
        <input type="hidden" id="saleId">
        
        <div>
          <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Cliente</label>
          <select id="clientId" class="input-field w-full" required>
            <option value="">Seleccionar cliente...</option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Producto</label>
          <select id="productId" class="input-field w-full" required>
            <option value="">Seleccionar producto...</option>
          </select>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Cantidad</label>
            <input type="number" id="quantity" min="1" value="1" class="input-field w-full" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Precio Unitario (‚Ç¨)</label>
            <input type="number" id="unitPrice" step="0.01" min="0" class="input-field w-full" required>
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Total</label>
          <input type="text" id="totalAmount" class="input-field w-full bg-slate-100 dark:bg-slate-700" readonly>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Tipo de Pago</label>
            <select id="paymentType" class="input-field w-full" required>
              <option value="one_time">Pago √önico</option>
              <option value="subscription">Suscripci√≥n</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Estado</label>
            <select id="paymentStatus" class="input-field w-full" required>
              <option value="pending">Pendiente</option>
              <option value="paid">Pagado</option>
              <option value="cancelled">Cancelado</option>
              <option value="refunded">Reembolsado</option>
            </select>
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Fecha de Venta</label>
          <input type="date" id="saleDate" class="input-field w-full" required>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Notas</label>
          <textarea id="notes" rows="2" class="input-field w-full"></textarea>
        </div>
        
        <div class="flex justify-end space-x-3 pt-4">
          <button type="button" id="cancelBtn" class="btn-secondary">Cancelar</button>
          <button type="submit" class="btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md mx-4 p-6">
      <h2 class="text-xl font-bold text-slate-900 dark:text-white mb-4">Eliminar Venta</h2>
      <p class="text-slate-600 dark:text-slate-300 mb-6">¬øEst√°s seguro de que quieres eliminar esta venta? Esta acci√≥n no se puede deshacer.</p>
      <input type="hidden" id="deleteSaleId">
      <div class="flex justify-end space-x-3">
        <button id="cancelDeleteBtn" class="btn-secondary">Cancelar</button>
        <button id="confirmDeleteBtn" class="btn-danger">Eliminar</button>
      </div>
    </div>
  </div>

  <script>
    import { getSales, searchSales, addSale, updateSale, deleteSale, getCustomers, getProducts, isReadOnly } from '../lib/supabase';
    import type { UserRole } from '../lib/supabase';
    import { checkAuth, isStaffUser } from '../lib/auth';
    import { format } from 'date-fns';
    import { es } from 'date-fns/locale';

    let currentUser: any = null;
    let allSales: any[] = [];
    let customers: any[] = [];
    let products: any[] = [];
    let readOnlyMode = false;

    function formatCurrency(amount: number): string {
      return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(amount);
    }

    const statusLabels: Record<string, string> = {
      paid: 'Pagado',
      pending: 'Pendiente',
      cancelled: 'Cancelado',
      refunded: 'Reembolsado'
    };

    const statusClasses: Record<string, string> = {
      paid: 'badge-success',
      pending: 'badge-warning',
      cancelled: 'badge-danger',
      refunded: 'badge-info'
    };

    async function init() {
      currentUser = await checkAuth();
      if (!currentUser || !isStaffUser(currentUser)) {
        window.location.href = '/login';
        return;
      }

      // Check read-only mode for staff role
      const role = currentUser.profile?.role as UserRole;
      readOnlyMode = isReadOnly(role);
      
      if (readOnlyMode) {
        const addBtn = document.getElementById('addSaleBtn');
        if (addBtn) addBtn.style.display = 'none';
      }

      // Set default dates
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      (document.getElementById('startDate') as HTMLInputElement).value = firstDay.toISOString().split('T')[0];
      (document.getElementById('endDate') as HTMLInputElement).value = today.toISOString().split('T')[0];
      (document.getElementById('saleDate') as HTMLInputElement).value = today.toISOString().split('T')[0];

      await Promise.all([loadSales(), loadCustomers(), loadProducts()]);
    }

    async function loadSales() {
      allSales = await getSales();
      renderSales(allSales);
      updateStats(allSales);
      const filteredCountEl = document.getElementById('filteredCount');
      if (filteredCountEl) filteredCountEl.textContent = allSales.length.toString();
    }

    async function loadCustomers() {
      customers = await getCustomers();
      const select = document.getElementById('clientId') as HTMLSelectElement;
      select.innerHTML = '<option value="">Seleccionar cliente...</option>' + 
        customers.map(c => `<option value="${c.id}">${c.full_name} (${c.email})</option>`).join('');
    }

    async function loadProducts() {
      products = await getProducts();
      const select = document.getElementById('productId') as HTMLSelectElement;
      select.innerHTML = '<option value="">Seleccionar producto...</option>' + 
        products.map(p => `<option value="${p.id}" data-price="${p.price || 0}">${p.name} - ${formatCurrency(p.price || 0)}</option>`).join('');
    }

    function renderSales(sales: any[]) {
      const tbody = document.getElementById('salesTableBody')!;
      
      if (sales.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-slate-500 dark:text-slate-400">No hay ventas registradas</td></tr>';
        return;
      }

      tbody.innerHTML = sales.map(sale => `
        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">
            ${format(new Date(sale.sale_date), 'dd MMM yyyy', { locale: es })}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-slate-900 dark:text-white">${sale.customer_name || '-'}</div>
            <div class="text-xs text-slate-500 dark:text-slate-400">${sale.customer_email || ''}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">${sale.product_name || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600 dark:text-slate-300">${sale.subscription_type || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-slate-900 dark:text-white">${formatCurrency(sale.amount)}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="${statusClasses[sale.payment_status] || 'badge-info'}">${statusLabels[sale.payment_status] || sale.payment_status}</span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            ${!readOnlyMode ? `<button onclick="editSale('${sale.id}')" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 mr-3">Editar</button>` : ''}
            ${!readOnlyMode ? `<button onclick="confirmDelete('${sale.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">Eliminar</button>` : '<span class="text-slate-400">-</span>'}
          </td>
        </tr>
      `).join('');
    }

    function updateStats(sales: any[]) {
      const totalCount = sales.length;
      const totalAmount = sales.filter(s => s.payment_status === 'paid').reduce((sum, s) => sum + (s.amount || 0), 0);
      const paidCount = sales.filter(s => s.payment_status === 'paid').length;
      const pendingCount = sales.filter(s => s.payment_status === 'pending').length;

      document.getElementById('totalSalesCount')!.textContent = totalCount.toString();
      document.getElementById('totalSalesAmount')!.textContent = formatCurrency(totalAmount);
      document.getElementById('paidSalesCount')!.textContent = paidCount.toString();
      document.getElementById('pendingSalesCount')!.textContent = pendingCount.toString();
    }

    // Modal handlers
    const modal = document.getElementById('saleModal')!;
    const deleteModal = document.getElementById('deleteModal')!;
    const form = document.getElementById('saleForm') as HTMLFormElement;

    document.getElementById('addSaleBtn')?.addEventListener('click', () => {
      document.getElementById('modalTitle')!.textContent = 'Nueva Venta';
      form.reset();
      (document.getElementById('saleId') as HTMLInputElement).value = '';
      (document.getElementById('saleDate') as HTMLInputElement).value = new Date().toISOString().split('T')[0];
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    });

    document.getElementById('cancelBtn')?.addEventListener('click', () => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    });

    // Calculate total
    const quantityInput = document.getElementById('quantity') as HTMLInputElement;
    const unitPriceInput = document.getElementById('unitPrice') as HTMLInputElement;
    const totalAmountInput = document.getElementById('totalAmount') as HTMLInputElement;
    const productSelect = document.getElementById('productId') as HTMLSelectElement;

    function updateTotal() {
      const qty = parseFloat(quantityInput.value) || 0;
      const price = parseFloat(unitPriceInput.value) || 0;
      totalAmountInput.value = formatCurrency(qty * price);
    }

    quantityInput?.addEventListener('input', updateTotal);
    unitPriceInput?.addEventListener('input', updateTotal);

    productSelect?.addEventListener('change', () => {
      const option = productSelect.options[productSelect.selectedIndex];
      const price = option.dataset.price || '0';
      unitPriceInput.value = price;
      updateTotal();
    });

    // Form submit
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const saleId = (document.getElementById('saleId') as HTMLInputElement).value;
      const clientId = (document.getElementById('clientId') as HTMLSelectElement).value;
      const productId = (document.getElementById('productId') as HTMLSelectElement).value;
      const quantity = parseInt((document.getElementById('quantity') as HTMLInputElement).value) || 1;
      const unitPrice = parseFloat((document.getElementById('unitPrice') as HTMLInputElement).value) || 0;
      
      const saleData = {
        customer_id: clientId || null,
        product_id: productId || null,
        amount: quantity * unitPrice,
        currency: 'EUR',
        payment_status: (document.getElementById('paymentStatus') as HTMLSelectElement).value || 'pending',
        payment_method: (document.getElementById('paymentType') as HTMLSelectElement).value || null,
        sale_date: (document.getElementById('saleDate') as HTMLInputElement).value || new Date().toISOString().split('T')[0],
        notes: (document.getElementById('notes') as HTMLTextAreaElement).value || null
      };

      try {
        if (saleId) {
          await updateSale(saleId, saleData);
        } else {
          await addSale(saleData as any);
        }
        
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        await loadSales();
      } catch (error) {
        console.error('Error saving sale:', error);
        alert('Error al guardar la venta');
      }
    });

    // Search
    document.getElementById('searchBtn')?.addEventListener('click', async () => {
      const searchTerm = (document.getElementById('searchInput') as HTMLInputElement).value;
      const startDate = (document.getElementById('startDate') as HTMLInputElement).value;
      const endDate = (document.getElementById('endDate') as HTMLInputElement).value;
      const status = (document.getElementById('statusFilter') as HTMLSelectElement).value;
      const method = (document.getElementById('methodFilter') as HTMLSelectElement)?.value;

      let results = await searchSales({
        searchTerm: searchTerm || undefined,
        startDate: startDate || undefined,
        endDate: endDate || undefined,
        status: status as any || undefined
      });

      // Filter by payment method locally if specified
      if (method) {
        results = results.filter((s: any) => s.payment_method === method);
      }

      const filteredCountEl = document.getElementById('filteredCount');
      if (filteredCountEl) filteredCountEl.textContent = results.length.toString();

      renderSales(results);
      updateStats(results);
    });
    
    document.getElementById('clearFilters')?.addEventListener('click', () => {
      (document.getElementById('searchInput') as HTMLInputElement).value = '';
      (document.getElementById('statusFilter') as HTMLSelectElement).value = '';
      (document.getElementById('methodFilter') as HTMLSelectElement).value = '';
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      (document.getElementById('startDate') as HTMLInputElement).value = firstDay.toISOString().split('T')[0];
      (document.getElementById('endDate') as HTMLInputElement).value = today.toISOString().split('T')[0];
      loadSales();
    });

    // Edit and Delete handlers
    (window as any).editSale = async (id: string) => {
      const sale = allSales.find(s => s.id === id);
      if (!sale) return;

      document.getElementById('modalTitle')!.textContent = 'Editar Venta';
      (document.getElementById('saleId') as HTMLInputElement).value = sale.id;
      (document.getElementById('clientId') as HTMLSelectElement).value = sale.client_id || '';
      (document.getElementById('productId') as HTMLSelectElement).value = sale.product_id || '';
      (document.getElementById('quantity') as HTMLInputElement).value = sale.quantity;
      (document.getElementById('unitPrice') as HTMLInputElement).value = sale.unit_price;
      (document.getElementById('paymentType') as HTMLSelectElement).value = sale.payment_type;
      (document.getElementById('paymentStatus') as HTMLSelectElement).value = sale.payment_status;
      (document.getElementById('saleDate') as HTMLInputElement).value = sale.sale_date;
      (document.getElementById('notes') as HTMLTextAreaElement).value = sale.notes || '';
      updateTotal();

      modal.classList.remove('hidden');
      modal.classList.add('flex');
    };

    (window as any).confirmDelete = (id: string) => {
      (document.getElementById('deleteSaleId') as HTMLInputElement).value = id;
      deleteModal.classList.remove('hidden');
      deleteModal.classList.add('flex');
    };

    document.getElementById('cancelDeleteBtn')?.addEventListener('click', () => {
      deleteModal.classList.add('hidden');
      deleteModal.classList.remove('flex');
    });

    document.getElementById('confirmDeleteBtn')?.addEventListener('click', async () => {
      const id = (document.getElementById('deleteSaleId') as HTMLInputElement).value;
      try {
        await deleteSale(id);
        deleteModal.classList.add('hidden');
        deleteModal.classList.remove('flex');
        await loadSales();
      } catch (error) {
        console.error('Error deleting sale:', error);
        alert('Error al eliminar la venta');
      }
    });

    init();
  </script>
</DashboardLayout>
