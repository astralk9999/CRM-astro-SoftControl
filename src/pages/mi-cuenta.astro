---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Mi Cuenta - SoftControl">
  <div id="loadingScreen" class="fixed inset-0 bg-gradient-to-br from-slate-50 via-indigo-50/30 to-slate-100 dark:from-slate-900 dark:via-indigo-950/20 dark:to-slate-900 z-50 flex items-center justify-center">
    <div class="text-center">
      <div class="w-16 h-16 rounded-full bg-white dark:bg-slate-800 shadow-xl shadow-indigo-500/10 flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-indigo-500 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </div>
      <p class="text-slate-600 dark:text-slate-400">Cargando tu cuenta...</p>
    </div>
  </div>

  <div id="mainContent" class="hidden min-h-screen bg-gradient-to-br from-slate-50 via-indigo-50/30 to-slate-100 dark:from-slate-900 dark:via-indigo-950/20 dark:to-slate-900">
    <!-- Header -->
    <nav class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-lg shadow-sm border-b border-slate-200/80 dark:border-slate-700/50 sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex items-center">
            <a href="/" class="flex items-center space-x-3 group">
              <img src="/images/logo-icon.png" alt="SoftControl" class="h-10 w-10 rounded-xl shadow-md group-hover:shadow-lg transition-all group-hover:scale-105" />
              <h1 class="text-xl font-bold text-slate-900 dark:text-white">SoftControl</h1>
            </a>
          </div>
          <div class="flex items-center space-x-4">
            <span id="userEmail" class="text-sm text-slate-500 dark:text-slate-400 hidden sm:block"></span>
            <button id="logoutBtn" class="btn-secondary text-sm">Cerrar SesiÃ³n</button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Welcome Section -->
      <div class="mb-8 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 flex items-center justify-center shadow-lg shadow-indigo-500/30">
            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">
              Bienvenido, <span id="userName" class="text-indigo-600 dark:text-indigo-400"></span>
            </h1>
            <p class="text-slate-500 dark:text-slate-400 text-sm">Gestiona tu cuenta y suscripciones desde aquÃ­</p>
          </div>
        </div>
      </div>

      <!-- Cards Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Subscription Card -->
        <div class="bg-white dark:bg-slate-800/50 rounded-2xl border border-slate-200/80 dark:border-slate-700/50 p-6 shadow-lg shadow-slate-200/50 dark:shadow-none">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-indigo-500/25">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                </svg>
              </div>
              <div class="ml-4">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white">Mi SuscripciÃ³n</h3>
                <p id="subscriptionStatus" class="text-sm text-slate-500 dark:text-slate-400">Cargando...</p>
              </div>
            </div>
            <div class="flex items-center gap-1">
              <button id="subPrev" class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 flex items-center justify-center text-slate-600 dark:text-slate-300 transition-colors" onclick="cycleSubscription(-1)" aria-label="Anterior">
                <span class="text-lg">â€¹</span>
              </button>
              <button id="subNext" class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 flex items-center justify-center text-slate-600 dark:text-slate-300 transition-colors" onclick="cycleSubscription(1)" aria-label="Siguiente">
                <span class="text-lg">â€º</span>
              </button>
            </div>
          </div>
          <div class="relative">
            <div id="subscriptionDetails" class="space-y-3 text-sm">
              <!-- Subscription details will be loaded here -->
            </div>
          </div>
        </div>

        <!-- Licenses Card -->
        <div class="bg-white dark:bg-slate-800/50 rounded-2xl border border-slate-200/80 dark:border-slate-700/50 p-6 shadow-lg shadow-slate-200/50 dark:shadow-none">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center shadow-lg shadow-emerald-500/25">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                </svg>
              </div>
              <div class="ml-4">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white">Mis Licencias</h3>
                <p id="licensesCount" class="text-sm text-slate-500 dark:text-slate-400">Cargando...</p>
              </div>
            </div>
            <div class="flex items-center gap-1">
              <button id="licPrev" class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 flex items-center justify-center text-slate-600 dark:text-slate-300 transition-colors" onclick="cycleLicenses(-1)" aria-label="Anterior licencias">
                <span class="text-lg">â€¹</span>
              </button>
              <button id="licNext" class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 flex items-center justify-center text-slate-600 dark:text-slate-300 transition-colors" onclick="cycleLicenses(1)" aria-label="Siguiente licencias">
                <span class="text-lg">â€º</span>
              </button>
            </div>
          </div>
          <div class="relative">
            <div id="licensesDetails" class="space-y-3 text-sm">
              <!-- Licenses will be loaded here -->
            </div>
          </div>
        </div>

        <!-- Support Card -->
        <div class="bg-white dark:bg-slate-800/50 rounded-2xl border border-slate-200/80 dark:border-slate-700/50 p-6 shadow-lg shadow-slate-200/50 dark:shadow-none">
          <div class="flex items-center mb-4">
            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center shadow-lg shadow-amber-500/25">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"></path>
              </svg>
            </div>
            <div class="ml-4">
              <h3 class="text-lg font-bold text-slate-900 dark:text-white">Soporte</h3>
              <p class="text-sm text-slate-500 dark:text-slate-400">Â¿Necesitas ayuda?</p>
            </div>
          </div>
          <a href="https://t.me/softcontrol_support_bot" target="_blank" rel="noopener" class="btn-primary w-full text-center block mb-3 shadow-lg shadow-indigo-500/25">
            <span class="flex items-center justify-center gap-2">
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
              </svg>
              Chat con Soporte IA
            </span>
          </a>
          <a href="mailto:soporte@softcontrol.com" class="btn-secondary w-full text-center block text-sm" id="emailSupportBtn">
            Enviar Email
          </a>
        </div>
      </div>

      <!-- Purchase / Upgrade Section -->
      <div id="purchaseSection" class="mt-8">
        <div class="bg-white dark:bg-slate-800/50 rounded-2xl border border-slate-200/80 dark:border-slate-700/50 p-6 mb-6 text-center shadow-lg shadow-slate-200/50 dark:shadow-none">
          <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center mx-auto shadow-lg shadow-indigo-500/25">
            <svg class="h-7 w-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
          </div>
          <h3 id="purchaseHeading" class="mt-4 text-xl font-bold text-slate-900 dark:text-white">Activa tu plan</h3>
          <p id="purchaseDescription" class="mt-2 text-slate-500 dark:text-slate-400">Elige el plan que mejor se adapte a tus necesidades.</p>
          <p class="text-xs text-slate-400 dark:text-slate-500 mt-3">Puedes comprar licencias adicionales cuando quieras.</p>
        </div>

        <div id="trialCard" class="bg-gradient-to-r from-emerald-50 to-teal-50 dark:from-emerald-900/20 dark:to-teal-900/20 rounded-2xl border-2 border-emerald-200 dark:border-emerald-700 p-6 mb-6 hidden">
          <div class="flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="text-center md:text-left">
              <h4 class="text-lg font-bold text-emerald-800 dark:text-emerald-300">ðŸŽ‰ Prueba Gratuita 14 dÃ­as</h4>
              <p class="text-sm text-emerald-600 dark:text-emerald-400">Acceso completo sin compromiso. Sin tarjeta de crÃ©dito.</p>
            </div>
            <button onclick="activateTrial()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-xl font-bold transition-all shadow-lg shadow-emerald-500/25 hover:shadow-emerald-500/40 whitespace-nowrap">
              Activar Prueba Gratis
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- Plan Mensual -->
          <div class="bg-white dark:bg-slate-800/50 rounded-2xl border border-slate-200/80 dark:border-slate-700/50 p-6 text-center hover:shadow-xl transition-all hover:-translate-y-1">
            <h4 class="text-lg font-bold text-slate-900 dark:text-white">Plan Mensual</h4>
            <p class="mt-2 text-3xl font-bold text-indigo-600 dark:text-indigo-400">9,99â‚¬<span class="text-sm text-slate-500 dark:text-slate-400">/mes</span></p>
            <ul class="mt-4 text-sm text-slate-600 dark:text-slate-400 space-y-2">
              <li>âœ“ Acceso completo</li>
              <li>âœ“ Soporte por email</li>
              <li>âœ“ Actualizaciones incluidas</li>
            </ul>
            <button onclick="redirectToStripe('monthly')" class="mt-6 btn-secondary w-full">Comprar licencia</button>
          </div>
          
          <!-- Plan Anual -->
          <div class="relative bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-6 text-center shadow-xl transform md:scale-105">
            <span class="absolute -top-3 left-1/2 -translate-x-1/2 bg-gradient-to-r from-amber-400 to-orange-500 text-white text-xs px-4 py-1 rounded-full font-bold">Popular</span>
            <h4 class="text-lg font-bold text-white">Plan Anual</h4>
            <p class="mt-2 text-3xl font-bold text-white">99,99â‚¬<span class="text-sm text-indigo-200">/aÃ±o</span></p>
            <p class="text-xs text-emerald-300 font-medium">Ahorra 20%</p>
            <ul class="mt-4 text-sm text-indigo-100 space-y-2">
              <li>âœ“ Todo del mensual</li>
              <li>âœ“ Soporte prioritario</li>
              <li>âœ“ 3 activaciones</li>
            </ul>
            <button onclick="redirectToStripe('annual')" class="mt-6 w-full bg-white text-indigo-600 py-2.5 px-4 rounded-xl font-bold hover:bg-indigo-50 transition-colors">Comprar licencia</button>
          </div>
          
          <!-- Licencia Definitiva -->
          <div class="bg-white dark:bg-slate-800/50 rounded-2xl border border-slate-200/80 dark:border-slate-700/50 p-6 text-center hover:shadow-xl transition-all hover:-translate-y-1">
            <h4 class="text-lg font-bold text-slate-900 dark:text-white">Licencia Definitiva</h4>
            <p class="mt-2 text-3xl font-bold text-indigo-600 dark:text-indigo-400">199,99â‚¬<span class="text-sm text-slate-500 dark:text-slate-400"> Ãºnico</span></p>
            <ul class="mt-4 text-sm text-slate-600 dark:text-slate-400 space-y-2">
              <li>âœ“ Pago Ãºnico</li>
              <li>âœ“ Acceso de por vida</li>
              <li>âœ“ 99 activaciones</li>
            </ul>
            <button onclick="redirectToStripe('lifetime')" class="mt-6 btn-secondary w-full">Comprar licencia</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    import { supabase, signOut, addSubscription, addLicense, addSale } from '../lib/supabase';
    import { checkAuth, isCustomer } from '../lib/auth';
    import { format } from 'date-fns';
    import { es } from 'date-fns/locale';

    // Stripe Payment Links
    const STRIPE_LINKS: Record<string, string> = {
      monthly: 'https://buy.stripe.com/test_9B6cMY6Oz9rqbYTcco08g00',
      annual: 'https://buy.stripe.com/test_5kQ14g1uf476fb51xK08g02',
      lifetime: 'https://buy.stripe.com/test_eVq14g7SD7ji6EzgsE08g01'
    };

    const planDurations: Record<string, number> = {
      trial: 14,
      monthly: 30,
      annual: 365,
      lifetime: 36500 // 100 aÃ±os
    };

    const planAmounts: Record<string, number> = {
      monthly: 9.99,
      annual: 99.99,
      lifetime: 199.99
    };

    const statusLabels: Record<string, string> = {
      active: 'Activa',
      trial: 'Prueba',
      cancelled: 'Cancelada',
      expired: 'Expirada',
      pending: 'Pendiente'
    };

    const subscriptionTypeLabels: Record<string, string> = {
      trial: 'Prueba Gratuita',
      monthly: 'Plan Mensual',
      annual: 'Plan Anual',
      lifetime: 'Licencia Definitiva'
    };

    let currentUser: any = null;
    let subscriptionsList: any[] = [];
    let rawSubscriptions: any[] = [];
    let currentSubscriptionIndex = 0;
    let licensesList: any[] = [];
    let licensePageIndex = 0;
    const LICENSES_PER_VIEW = 1;

    // Function to activate free trial (only used when no subscriptions)
    (window as any).activateTrial = async () => {
      if (!currentUser?.customer?.id) {
        alert('Error: No se pudo obtener la informaciÃ³n del usuario');
        return;
      }

      const btn = document.querySelector('#trialCard button') as HTMLButtonElement;
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Activando...';
      }

      try {
        const trialEnd = new Date();
        trialEnd.setDate(trialEnd.getDate() + 14);

        const { data: subData, error: subError } = await addSubscription({
          customer_id: currentUser.customer.id,
          product_id: null,
          subscription_type: 'trial',
          status: 'trial',
          start_date: new Date().toISOString().split('T')[0],
          end_date: trialEnd.toISOString().split('T')[0],
          trial_ends_at: trialEnd.toISOString(),
          auto_renew: false,
          payment_status: 'pending',
          amount: 0,
          currency: 'EUR'
        } as any);

        if (subError) {
          console.error('Error creating trial subscription:', subError);
          alert('Error al activar la prueba. Por favor, intenta de nuevo.');
          return;
        }

        const generateTrialKey = () => {
          const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
          const parts: string[] = [];
          for (let i = 0; i < 4; i++) {
            let part = '';
            for (let j = 0; j < 4; j++) {
              part += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            parts.push(part);
          }
          return 'TRIAL-' + parts.join('-');
        };

        const { error: licError } = await addLicense({
          customer_id: currentUser.customer.id,
          subscription_id: subData?.id || null,
          license_key: generateTrialKey(),
          status: 'active',
          activation_date: new Date().toISOString().split('T')[0],
          expiration_date: trialEnd.toISOString().split('T')[0],
          max_activations: 1,
          current_activations: 1
        } as any);

        if (licError) {
          console.error('Error creating trial license:', licError);
        }

        window.location.reload();
      } catch (err) {
        console.error('Error activating trial:', err);
        alert('Error al activar la prueba.');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Activar Prueba Gratis';
        }
      }
    };

    (window as any).cycleSubscription = (direction: number) => {
      if (!subscriptionsList.length) return;
      currentSubscriptionIndex = (currentSubscriptionIndex + direction + subscriptionsList.length) % subscriptionsList.length;
      renderSubscription();
    };

    (window as any).cycleLicenses = (direction: number) => {
      if (!licensesList.length) return;
      const totalPages = Math.ceil(licensesList.length / LICENSES_PER_VIEW);
      licensePageIndex = (licensePageIndex + direction + totalPages) % totalPages;
      renderLicenses();
    };

    // Function to redirect to Stripe (exposed globally)
    (window as any).redirectToStripe = async (plan: string) => {
      if (!currentUser?.customer?.id || !currentUser?.email) {
        alert('Error: No se pudo obtener la informaciÃ³n del usuario');
        return;
      }

      const stripeUrl = STRIPE_LINKS[plan];
      if (!stripeUrl) {
        alert('Error: Plan no vÃ¡lido');
        return;
      }

      // Create subscription and license before redirecting
      try {
        const endDate = new Date();
        endDate.setDate(endDate.getDate() + (planDurations[plan] || 30));

        console.log('Creating subscription for plan:', plan, 'customer:', currentUser.customer.id);

        // Create subscription with 'pending' status - will be activated via Stripe webhook
        const { data: subData, error: subError } = await addSubscription({
          customer_id: currentUser.customer.id,
          product_id: null,
          subscription_type: plan as 'monthly' | 'annual' | 'lifetime',
          status: 'pending', // Pending until payment is confirmed via webhook
          start_date: new Date().toISOString().split('T')[0],
          end_date: endDate.toISOString().split('T')[0],
          trial_ends_at: null,
          auto_renew: plan !== 'lifetime',
          payment_status: 'pending',
          amount: planAmounts[plan] || 0,
          currency: 'EUR'
        } as any);

        console.log('Subscription result:', { subData, subError });

        // Generate license key
        const generateLicenseKey = (prefix: string) => {
          const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
          const parts = [];
          for (let i = 0; i < 4; i++) {
            let part = '';
            for (let j = 0; j < 4; j++) {
              part += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            parts.push(part);
          }
          return prefix + '-' + parts.join('-');
        };

        const licensePrefix = plan === 'lifetime' ? 'LIFE' : plan === 'annual' ? 'ANUAL' : 'MENS';
        const licenseKey = generateLicenseKey(licensePrefix);

        console.log('Creating license with key:', licenseKey);

        // Create license with 'inactive' status - will be activated via Stripe webhook
        const { data: licData, error: licError } = await addLicense({
          customer_id: currentUser.customer.id,
          subscription_id: subData?.id || null,
          license_key: licenseKey,
          status: 'inactive', // Inactive until payment is confirmed via webhook
          activation_date: new Date().toISOString().split('T')[0],
          expiration_date: endDate.toISOString().split('T')[0],
          max_activations: plan === 'lifetime' ? 99 : (plan === 'annual' ? 3 : 1),
          current_activations: 0
        } as any);

        console.log('License result:', { licData, licError });

        if (licError) {
          console.error('License creation failed:', licError);
          // Show error visually
          const errorDiv = document.createElement('div');
          errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white p-4 rounded-lg shadow-lg z-50';
          errorDiv.innerHTML = `<strong>Error licencia:</strong> ${licError.message}`;
          document.body.appendChild(errorDiv);
          // Don't redirect if there's an error, wait for user to see it
          await new Promise(resolve => setTimeout(resolve, 3000));
        }

        // Create pending sale record - will be updated to 'paid' via Stripe webhook
        if (subData?.id) {
          const { error: saleError } = await addSale({
            customer_id: currentUser.customer.id,
            subscription_id: subData.id,
            amount: planAmounts[plan] || 0,
            currency: 'EUR',
            payment_status: 'pending',
            payment_type: 'stripe',
            sale_date: new Date().toISOString().split('T')[0],
            notes: `Pago pendiente - ${plan === 'monthly' ? 'Mensual' : plan === 'annual' ? 'Anual' : 'Definitiva'}`
          } as any);

          if (saleError) {
            console.error('Error creating pending sale:', saleError);
          } else {
            console.log('Pending sale created for subscription:', subData.id);
          }
        }
      } catch (err: any) {
        console.error('Error creating subscription/license:', err);
        const errorDiv = document.createElement('div');
        errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white p-4 rounded-lg shadow-lg z-50';
        errorDiv.innerHTML = `<strong>Error:</strong> ${err.message || 'Error desconocido'}`;
        document.body.appendChild(errorDiv);
        await new Promise(resolve => setTimeout(resolve, 3000));
      }

      // Redirect to Stripe
      const finalUrl = `${stripeUrl}?prefilled_email=${encodeURIComponent(currentUser.email)}`;
      window.location.href = finalUrl;
    };

    async function init() {
      const loadingScreen = document.getElementById('loadingScreen');
      const mainContent = document.getElementById('mainContent');
      
      const user = await checkAuth();
      
      if (!user || !isCustomer(user)) {
        window.location.href = '/login';
        return;
      }

      // Store user globally for redirectToStripe
      currentUser = user;

      // Show content
      if (loadingScreen) loadingScreen.classList.add('hidden');
      if (mainContent) mainContent.classList.remove('hidden');

      // Set user info
      const userName = document.getElementById('userName');
      const userEmail = document.getElementById('userEmail');
      
      if (userName) userName.textContent = user.customer?.full_name || 'Usuario';
      if (userEmail) userEmail.textContent = user.email;

      // Load subscription info
      await loadSubscription(user.customer?.id);
      await loadLicenses(user.customer?.id);
    }

    function getLicenseTypeKey(lic: any) {
      if (lic.subscription_type) return lic.subscription_type;
      if (lic.license_key?.startsWith('LIFE')) return 'lifetime';
      if (lic.license_key?.startsWith('ANUAL')) return 'annual';
      if (lic.license_key?.startsWith('MENS')) return 'monthly';
      if (lic.license_key?.startsWith('TRIAL')) return 'trial';
      return 'monthly';
    }

    function getLicenseTypeLabel(key: string) {
      return subscriptionTypeLabels[key] || key;
    }

    function mergeLicenseSubscriptions() {
      const nonTrialSubs = rawSubscriptions.filter(s => s.subscription_type !== 'trial');
      const trialSubs = rawSubscriptions.filter(s => s.subscription_type === 'trial');

      const derivedSubs = licensesList
        .map(lic => {
          const typeKey = getLicenseTypeKey(lic);
          if (typeKey === 'trial') return null;
          return {
            id: `license-${lic.id}`,
            status: 'active',
            subscription_type: typeKey,
            product_name: lic.product_name || getLicenseTypeLabel(typeKey),
            start_date: lic.activation_date,
            end_date: lic.expiration_date,
            trial_ends_at: null,
            fromLicense: true
          };
        })
        .filter(Boolean) as any[];

      let combined: any[] = [];
      if (nonTrialSubs.length) {
        combined = [...nonTrialSubs];
      }
      if (derivedSubs.length) {
        combined = [...combined, ...derivedSubs];
      }
      if (!combined.length) {
        combined = [...trialSubs];
      }

      subscriptionsList = combined;
      if (currentSubscriptionIndex >= subscriptionsList.length) {
        currentSubscriptionIndex = Math.max(subscriptionsList.length - 1, 0);
      }
      if (subscriptionsList.length === 0) {
        renderSubscription();
      } else {
        renderSubscription();
      }
    }

    function renderSubscription() {
      const subscriptionStatus = document.getElementById('subscriptionStatus');
      const subscriptionDetails = document.getElementById('subscriptionDetails');
      const noSubscription = document.getElementById('noSubscription');
      const trialCard = document.getElementById('trialCard');

      if (!subscriptionsList.length) {
        if (subscriptionStatus) subscriptionStatus.textContent = 'Sin suscripciÃ³n';
        if (subscriptionDetails) subscriptionDetails.innerHTML = '<p class="text-slate-500 dark:text-slate-400">No hay suscripciones activas.</p>';
        if (noSubscription) noSubscription.classList.remove('hidden');
        if (trialCard) trialCard.classList.remove('hidden');
        return;
      }

      const sub = subscriptionsList[currentSubscriptionIndex];

      if (subscriptionStatus) {
        subscriptionStatus.textContent = statusLabels[sub.status] || sub.status;
      }
      if (noSubscription) {
        noSubscription.classList.add('hidden');
      }
      if (trialCard) {
        trialCard.classList.add('hidden');
      }
      if (subscriptionDetails) {
        const planName = sub.product_name || subscriptionTypeLabels[sub.subscription_type] || sub.subscription_type;
        subscriptionDetails.innerHTML = `
          <div class="flex justify-between py-2 border-b border-slate-100 dark:border-slate-700">
            <span class="text-slate-600 dark:text-slate-400">Plan:</span>
            <span class="font-medium text-slate-900 dark:text-white">${planName}</span>
          </div>
          ${sub.end_date ? `
          <div class="flex justify-between py-2 border-b border-slate-100 dark:border-slate-700">
            <span class="text-slate-600 dark:text-slate-400">VÃ¡lido hasta:</span>
            <span class="font-medium text-slate-900 dark:text-white">${format(new Date(sub.end_date), 'dd MMM yyyy', { locale: es })}</span>
          </div>
          ` : ''}
          ${sub.trial_ends_at ? `
          <div class="flex justify-between py-2">
            <span class="text-slate-600 dark:text-slate-400">Prueba termina:</span>
            <span class="font-medium text-slate-900 dark:text-white">${format(new Date(sub.trial_ends_at), 'dd MMM yyyy', { locale: es })}</span>
          </div>
          ` : ''}
        `;
      }
    }

    function renderLicenses() {
      const licensesCount = document.getElementById('licensesCount');
      const licensesDetails = document.getElementById('licensesDetails');

      if (licensesCount) {
        licensesCount.textContent = `${licensesList.length} licencia(s) activa(s)`;
      }

      if (!licensesDetails) return;

      if (!licensesList.length) {
        licensesDetails.innerHTML = '<p class="text-slate-500 dark:text-slate-400">No hay licencias activas</p>';
        return;
      }

      const totalPages = Math.ceil(licensesList.length / LICENSES_PER_VIEW);
      if (licensePageIndex >= totalPages) {
        licensePageIndex = totalPages - 1;
      }
      if (licensePageIndex < 0) licensePageIndex = 0;

      const start = licensePageIndex * LICENSES_PER_VIEW;
      const slice = licensesList.slice(start, start + LICENSES_PER_VIEW);

      licensesDetails.innerHTML = slice.map(lic => {
        const licenseType = lic.product_name || getLicenseTypeLabel(getLicenseTypeKey(lic));
        return `
          <div class="p-3 bg-slate-50 dark:bg-slate-700 rounded-lg space-y-1">
            <div class="font-medium text-slate-900 dark:text-white text-sm">${licenseType}</div>
            <code class="text-xs text-slate-500 dark:text-slate-400 block">${lic.license_key}</code>
            ${lic.expiration_date ? `<div class="text-xs text-slate-500 dark:text-slate-400">Vence: ${format(new Date(lic.expiration_date), 'dd MMM yyyy', { locale: es })}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    async function loadSubscription(customerId: string | undefined) {
      if (!customerId) return;

      const { data: subscriptions } = await supabase
        .from('subscriptions_full')
        .select('*')
        .eq('customer_id', customerId)
        .order('created_at', { ascending: false });

      rawSubscriptions = subscriptions || [];
      currentSubscriptionIndex = 0;
      mergeLicenseSubscriptions();
    }

    async function loadLicenses(customerId: string | undefined) {
      if (!customerId) return;

      const { data: licenses } = await supabase
        .from('licenses_full')
        .select('*')
        .eq('customer_id', customerId);
      licensesList = licenses?.filter(l => l.status === 'active') || [];
      licensePageIndex = 0;
      renderLicenses();
      mergeLicenseSubscriptions();
    }

    // Logout
    document.getElementById('logoutBtn')?.addEventListener('click', async () => {
      await signOut();
      window.location.href = '/login';
    });

    document.getElementById('emailSupportBtn')?.addEventListener('click', (event) => {
      event.preventDefault();
      const supportEmail = 'soporte@softcontrol.com';
      const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(supportEmail)}`;
      const win = window.open(gmailUrl, '_blank');
      if (!win || win.closed || typeof win.closed === 'undefined') {
        window.location.href = `mailto:${supportEmail}`;
      }
    });

    init();
  </script>
</Layout>
